{% extends "base/layout.html" %}

{% block title %}Completing Sign In - RepairOS{% endblock %}

{% block breadcrumb %}{% endblock %}

{% block content %}
<div class="row justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="col-lg-4 col-md-6 text-center">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-5">
                <div class="mb-4">
                    <div class="spinner-border text-primary" role="status" id="loadingSpinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <h3 class="fw-bold mb-2" id="statusTitle">Completing sign in...</h3>
                <p class="text-muted" id="statusMessage">Please wait while we set up your session.</p>

                <div id="errorActions" class="d-none mt-4">
                    <a href="{{ url_for('auth.login') }}" class="btn btn-accent">
                        <i class="ti ti-arrow-left me-2"></i>Back to Sign In
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorActions = document.getElementById('errorActions');

    function showError(message) {
        loadingSpinner.classList.add('d-none');
        statusTitle.textContent = 'Sign in failed';
        statusMessage.textContent = message;
        errorActions.classList.remove('d-none');
    }

    if (!window.neonAuth) {
        showError('Authentication service not configured. Please try again.');
        return;
    }

    // Check if neonAuth.checkSessionVerifier already handled the redirect
    // (it runs on DOMContentLoaded too, but this page is specifically for the bridge flow)
    const params = new URLSearchParams(window.location.search);
    const verifier = params.get('neon_auth_session_verifier');

    // If there's a verifier, checkSessionVerifier in neon-auth.js will handle it.
    // Only proceed here if there's no verifier (this is the /auth/callback bridge).
    if (verifier) {
        // Let checkSessionVerifier handle it â€” just wait
        return;
    }

    try {
        // Get session from Neon Auth (client-side cookies are visible to Neon Auth domain)
        const sessionData = await window.neonAuth.getSession();
        const token = sessionData ? (sessionData.token || null) : null;

        if (!sessionData) {
            showError('Could not retrieve session. Please sign in again.');
            return;
        }

        // Forward token to Flask backend
        const payload = {};
        if (token) {
            payload.token = token;
        }

        const response = await fetch('/auth/neon-callback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            window.location.href = data.redirect || '/dashboard';
        } else {
            showError('Could not establish session. Please sign in again.');
        }
    } catch (error) {
        console.error('OAuth completion error:', error);
        showError('An error occurred. Please try again.');
    }
});
</script>
{% endblock %}
